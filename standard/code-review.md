# 代码review常见问题分类与整理

## 一、开发规范

### 1 不遵守日志规范

常见错误：

* 日志格式自定义 -- 所有日志都通过framework的Log类生成，就能保证日志规范性
* 打日志没有把关键的调试信息打出来 -- 关键的日志信息必须以kv的形式打出来

### 2 不遵守异常规范

[异常处理规范](exception-simplify.md)，里面有异常处理过程中需要遵循的一些准则和一些代码示例。

常见错误：

* 过多地抓异常， 目前除了API这一层必须抓所有异常，dubbo服务只针对必要的异常才抓
* 吃掉了异常日志
* 未使用公共父类的异常


### 3 未使用公共的库或代码

尽量使用公共framework里的公共库。

### 4 代码嵌套层次过深

建议采用一些代码规范来减少嵌套。if else或for循环都有自己的模式。

如下面的代码

```
        if(condition1) {
            // ..some code1
			if(condition2) {
				// ..some code2
				if(condition3) {
					// ..some code3
				}
			}
        }
```

可改为

```
		if(!condition1) {
			return ;
		}
        // ..some code1
		if(!condition2) {
			return ;
		}
		// ..some code2
		if(!condition3) {
			reutrn ;
		}
		// ..some code3
```

### 5 单个方法的代码行数过多

常用的优化方法：

* 重构提炼函数
* 优化处理逻辑流程

### 6 代码风格不统一

建议按照[Java代码开发规范](code.md)中的说明，使用统一的Java Formatter配置。


## 二、数据库问题

### 1 均衡字段设计不正确

* 通常采用的均衡字段是前端访问最频繁的字段，如customerId。
* 如果是分级的（如一/二级商户）， 一般会以一级商户号作为均衡字段。
* 在多种维度查询都较多时，一般均衡字段考虑是先C后B，最后OMS。如果OMS查询确实过慢的话会用全文检索或其它手段优化。

### 2 查询无法使用均衡字段，且速度很慢

在多种维度查询都较多时，一般均衡字段考虑是先C后B，最后OMS。如果确实没法解决，可告知基础平台组。


### 3 应该使用事务时未使用

如果业务逻辑上需要多个数据库操作的情况要一起提交，需要在方法前加事务的annotation

### 4 事务处理不生效

* 在同一个service里调用另一个方法，事务是不生效的。只有通过service引用调用，才会经过AOP处理。

### 5 需要使用批量插入来优化插入速度

根据具体业务分析，提高插入速度。

### 6 需要通过乐观锁来防止的数据重复update的情况

与资金相关的表，建议到加上version字段。 在update时通过version来解决多次update会出现数据覆盖的情况。

## 三、架构类

### 1 使用同步接口，可能有较大性能问题，需要改异步

注意一些同步方法会让特定用户在一段时间内卡死。如以下逻辑：

* 当产品募集到100个用户时成立产品。如果用同步方法，则第100个用户可能卡死。

### 2 未处理接口幂等性

以下接口尤其需要注意调用的幂等性：

* 调度任务
* rabbitmq接收端的任务  

### 3 接口在并发访问时出错

一些接口不能并发访问，注意并发访问时的条件。 可以通过以下方法优化：

* 用数据库的某个字段标志数据已在处理
* 分布式锁

### 4 调度接口目前需要手工清异步标志

当需要调用dubbo服务，且该dubbo服务有返回值时，该调度接口需要手工清异步标志。

```
RpcContext.getContext().clearAttachments();
```

说明：
这是目前的临时做法，以后所有的调度都使用framework加annotation，正在开发中。 
