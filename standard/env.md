# 环境规划

## 目前环境概况
### 云平台简介
- 完全使用了网易云平台；
- 网易云平台的使用是以租户为单位，每个租户有1个私有网络，不同租户的私有网络ip是重叠的。
- 每个租户连接私有网络的时候，有独立的vpn配置文件
- 不同租户的网络相互隔离，无法同时连接多个租户的私有网络

### 目前已有环境

介绍一下，目前各个环境的作用，以及各个环境所在的租户；

|环境名称|环境描述|环境对应的租户|
|-----|-------|-----|
|开发环境|开发人员本地联调的环境|开发环境的租户|
|测试环境|测试人员测试功能的环境|测试环境的租户|
|联调环境|线下的稳定环境，主要用于演示，跟测试环境共用数据库|测试环境的租户|
|压测环境|性能测试的环境|生产环境的租户|
|预发布环境|跟生产大致相同的环境，可以引入生产的一些流量，跟生产环境共用数据库|生产环境的租户|
|生产环境|对外发布的环境|生产环境的租户|

### 技术背景
目前开发的时候，服务间的通信，主要采用了dubbo作为服务通信的框架。

dubbo主要概念就是服务的消费者和服务的提供者。服务的提供者和服务的生产者之间有强依赖关系。

因此，下文把服务简单称呼为：被依赖方、主动依赖方。

### 目前存在的问题 

目前关于环境方面的一些问题

- 被依赖方的服务不稳定
- 同1个租户内的环境冲突
- 随着项目增多，环境线性膨胀
- 环境部署代价较高

环境问题严重影响了开发和测试人员的效率，因此需要重新做好规划。

## 环境规划

### 环境规划的目标
- 解决现有的问题
- 兼顾未来的增长

### 现有问题的解决方案
#### 1）被依赖方的服务不稳定
被依赖方的服务不稳定的时候，就会影响到主动依赖方。

##### 现实场景
目前现金宝、消费信托都依赖业务平台，业务平台的服务重启，就会直接影响到其他产品的开发和联调。这个场景主要发生在开发环境，开发人员在进行联调的时候，会经常发生。

##### 解决方法
被依赖方，需要提供1套稳定的环境给主动依赖方，各自的开发联调互相隔离，不相互影响；

#### 2）同1个租户内的环境冲突
如果同1个服务注册了多个提供者，那么消费者调用服务的时候，调用就有可能会被分发到2个提供者，但联调的时候，大部分情况都希望消费者的调用落在某个具体的提供者。

##### 现实场景
假设为了解决上面提到的`被依赖方服务不稳定`的问题，需要在开发环境部署2套应用平台，由于是在同1个租户内，若2套不加以区分，现金宝调用的时候也不清楚自己调用的是稳定的那一套还是不稳定的那一套；

##### 解决方法
引入dubbo的分组和版本号的概念，每1套环境指定相同的group。

- 引入了分组，那么消费者只能调用同1个分组内的提供者；
- 引入了版本号，那么同1个分组内，消费者只能调用相同版本的提供者。

#### 3）环境增长快速
现在项目逐渐增多，以后新项目的接入，都会依赖目前的应用平台、现金宝和银行通道，已有的功能可能都需要变更。按照上面`同1个租户内的环境冲突`的问题，如果为了解决每个产品的联调问题，可能需要为每一个接进来的产品部署一套系统，但这样会导致环境迅速和直线扩张，运维和维护成本巨大。

##### 现实场景
最近新增的海盗项目，同样依赖应用平台的会员、交易，银行通道等，如果完全部署一套应用平台和银行通道，对于海盗项目和应用平台来说都需要相当长的时间。

##### 解决方法
尽量使用被依赖方提供的稳定的环境，某些确实需要修改的服务再独立部署。

- 有改动的时候，尽量做到接口向下兼容、
- 有改动的服务尽量合并回原来的分支，合并到原来的稳定服务中
- 没办法的情况下，再部署有改动的服务

#### 总结
- 被依赖方，需要提供1套稳定的环境给主动依赖方，各自的开发联调互相隔离，不相互影响；
- 引入dubbo的分组和版本号的概念，每1套环境指定相同的group；
- 尽量使用被依赖方提供的稳定的环境，某些确实需要修改的服务再独立部署；

### 分组和版本号的规范

下面定义一下，分组和版本号的规范。

规范概览：

- group:  跟着数据库走
- version： 自增即可，灰度发布也必须要版本号。

#### group的规范

	${env}_${环境类型}

各个项的说明

- env：譬如，开发环境(dev)、测试环境(test)
- 环境类型：譬如，稳定版(stable)、开发版本(开发版本暂时不需要加group)

#### version的规范

version的规范，希望稳定版和开发版能够分开。

##### 稳定版版本规范
希望能以上线的时间作为版本号，譬如150910，这也是为了保证稳定版足够稳定。
**注意：稳定版的版本号，是否需要有待商榷，因为如果开发环境的稳定版升级的话，消费者都需要升级版本号，工作量较大**

##### 开发版版本规范
从0.0.1开始逐渐递增即可。

### 规范举例

#### group是什么鬼？
group简介

- 在这份规范里面，group仅是为了做服务的隔离。
- group的配置是无侵入的（即配置group与否不需要改代码，只需要改配置，下面会说到）

对于1个服务而言，暴露了group与否的差别，在dubbo-admin上看到是这样的：

![servicegroup](img/servicegroup.png)

上面可以理解为IPartnerPasswordService部署了2份，1份的group为dev_stable，1份是没有group的

group注意

- 调用Service的时候，只有group匹配的话，才能调用到；
- 如果服务生产者没有配置group的话，只能调用到没有group的服务
- 如果服务生产者配置了group的话，只会调用到配置了group的服务
- 简单地说，我们这里是为了隔离

#### 需要配置什么group？

为了解决目前的问题，暂时只需要在开发和测试环境部署相应的稳定版本；联调、预发布、压测、生产，暂时都只需要一套环境即可。即：

|环境名称|group配置|
|-----|-------|
|开发环境快照版|不需要配置|
|开发环境稳定版|dev_stable|
|测试环境快照版|不需要配置|
|测试环境稳定版|test_stable|
|联调环境|不需要配置|
|压测环境|不需要配置|
|预发布环境|不需要配置|
|生产环境|不需要配置|

#### 什么时候需要配置group？
实际场景说明，以现金宝、应用平台、开发环境为例：

- 若现金宝本迭代开发的功能和应用平台没有关系，即现金宝新功能依赖应用平台老功能，那么可以直接连应用平台的稳定版做联调（配置服务的group为dev_stable）
- 若现金宝本迭代开发的功能需要和应用平台联调，即现金宝新功能依赖应用平台新功能，那么该新功能可以用开发版的服务（则不需要配置group）

#### 怎么配置group？
对于1个应用来说，可以是服务的消费者，也可以是服务的生产者；

group的配置，在`dubbo.properties`里面配置即可；

#### 服务生产者的配置

    dubbo.service.group=dev_stable

应用的`dubbo.properties`加上这样的一行配置，那么整个应用暴露的Service都会带上这个group

#### 服务消费者的配置（所有引用的group都一样）
这种情况比较适用于底层的服务，譬如应用平台的开发stable环境来说，所有的服务的group都是dev_stable，而且服务都是内部互相调用而已，那么可以这样配置：
    
    dubbo.reference.group=dev_stable

#### 服务消费者的配置（对每个Service进行配置）
对于上层服务来说，1个应用内部可能会调用其他上层服务，也有可能会调用应用平台的服务，譬如ct-product可能会调用ct-order的Service，也会调用ap-customer的Service，那么group的配置就必须针对单个Service，譬如

	<!-- 引用ap-customer的Service -->	
	<dubbo:reference interface="com.ihome.basicbiz.partner.service.IPartnerBankcardService"
		id="partnerBankcardService">
	<!-- 引用ct-order的Service -->
	<dubbo:reference interface="com.ihome.trust.order.service.IProductFoundService"
		id="productFoundService">

那么dubbo.properties的配置是：

    dubbo.reference.partnerBankcardService.group=dev_stable

这里只需要单独对应用平台的IPartnerBankcardService加上group，对自己内部的IProductFoundService则不需要
